// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

enum Estado {
  PENDIENTE
  APROBADO
  ACTIVO
  RECHAZADO
}

enum Genero {
  MASCULINO
  FEMENINO
  MASCULINO_FEMENINO
}

enum TipoRol {
  SUPER_ADMIN
  ADMIN
  SECRETARIA
  DTM
  DTM_EIDE
  ENTRENADOR
  USUARIO
  DEPORTISTA
  PDA
  FINANCIERO
}

generator client {
  provider = "prisma-client-js"
}

// generator erd {
//   provider = "prisma-erd-generator"
//   output   = "./erd.svg" // Output file for the diagram
// }

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL")
}


model Rol {
  id          Int          @id @default(autoincrement())
  nombre      TipoRol      @unique
  descripcion String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deleted     Boolean      @default(false)
  usuariosRol UsuarioRol[]

  @@index([deleted])
  @@index([nombre])
}

model Usuario {
  id                 Int                   @id @default(autoincrement())
  email              String                @unique
  password           String                
  nombre             String
  apellido           String
  cedula             String                @unique
  categoriaId        Int
  disciplinaId       Int
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  deleted            Boolean               @default(false)
  categoria          Categoria             @relation(fields: [categoriaId], references: [id])
  disciplina         Disciplina            @relation(fields: [disciplinaId], references: [id])
  usuariosRol        UsuarioRol[]
  historialColeccion HistorialColeccion[]
  historialSolicitud HistorialAvalTecnico[]
  historialPda       HistorialPda[]
  historialDtm       HistorialDtm[]
  historialFinanciero HistorialFinanciero[]
  coleccionesEntrenador ColeccionEntrenador[]
  

  @@index([nombre])
  @@index([deleted])
}

model UsuarioRol {
  usuarioId Int
  rolId     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  rol     Rol     @relation(fields: [rolId], references: [id], onDelete: Cascade)

  @@id([usuarioId, rolId])
  @@index([usuarioId])
  @@index([rolId])
}
model Disciplina {
  id           Int               @id @default(autoincrement())
  nombre       String            @db.VarChar(150) @unique
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  deleted      Boolean           @default(false)
  usuarios     Usuario[]
  deportistas  Deportista[]
  colecciones  Evento[]

  @@index([deleted])
}

model Categoria {
  id           Int               @id @default(autoincrement())
  nombre       String            @db.VarChar(150) @unique
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  deleted      Boolean           @default(false)
  usuarios     Usuario[]
  deportistas  Deportista[]
  colecciones  Evento[]

  @@index([deleted])
}


model Deportista {
  id               Int              @id @default(autoincrement())
  nombres          String           @db.VarChar(150)
  apellidos        String           @db.VarChar(150)
  cedula           String           @db.VarChar(50)
  fechaNacimiento  DateTime
  categoriaId      Int
  disciplinaId     Int
  afiliacion       Boolean          @default(false)
  genero           Genero
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deleted          Boolean          @default(false)

  categoria        Categoria        @relation(fields: [categoriaId], references: [id])
  disciplina       Disciplina       @relation(fields: [disciplinaId], references: [id])
  deportistasAval  DeportistaAval[]

  @@index([nombres])
  @@index([categoriaId])
  @@index([deleted])
}

model Evento {
  id                       Int      @id @default(autoincrement())
  codigo                   String   @db.VarChar(100)
  tipoParticipacion        String   @db.VarChar(100) // nacional, internacional, etc.
  tipoEvento               String   @db.VarChar(100) // campeonato, torneo, etc.
  nombre                   String   @db.VarChar(255)
  lugar                    String   @db.VarChar(255)
  genero                   Genero
  disciplinaId             Int
  categoriaId              Int
  provincia                String   @db.VarChar(100)
  ciudad                   String   @db.VarChar(100)
  pais                     String   @db.VarChar(100)
  alcance                  String   @db.VarChar(100) // local, regional, nacional, internacional
  fechaInicio              DateTime
  fechaFin                 DateTime
  numEntrenadoresHombres   Int
  numEntrenadoresMujeres   Int
  numAtletasHombres        Int
  numAtletasMujeres        Int

  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  deleted                  Boolean  @default(false)
  eventoEdiciones          EventoEdicion[]

  disciplina         Disciplina             @relation(fields: [disciplinaId], references: [id])
  categoria          Categoria              @relation(fields: [categoriaId], references: [id])

  @@index([nombre])
  @@index([fechaInicio])
}

model EventoEdicion {
  id                      Int      @id @default(autoincrement())
  eventoId                Int
  lugar                   String   @db.VarChar(255)
  provincia               String   @db.VarChar(100)
  ciudad                  String   @db.VarChar(100)
  pais                    String   @db.VarChar(100)
  fechaInicio             DateTime
  fechaFin                DateTime
  numEntrenadoresHombres  Int
  numEntrenadoresMujeres  Int
  numAtletasHombres       Int
  numAtletasMujeres       Int
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  evento                  Evento   @relation(fields: [eventoId], references: [id])

  collection              ColeccionAval[]

  @@unique([eventoId, fechaInicio, ciudad])
}


// ------------------
// Modelo base de colección de avales
// ------------------
model ColeccionAval {
  id               Int                 @id @default(autoincrement())
  descripcion      String              @db.VarChar(600)
  eventoEdicionId  Int             
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  
  // Un Aval Técnico por colección
  avalTecnico      AvalTecnico?
  pda              Pda[]
  dtm              Dtm[]
  financiero       Financiero[]
  historial        HistorialColeccion[]
  entrenadores     ColeccionEntrenador[]
  eventoEdicion    EventoEdicion              @relation(fields: [eventoEdicionId], references: [id])

}

// ------------------
// HISTORIAL DE LA COLECCIÓN
// ------------------
model HistorialColeccion {
  id              Int            @id @default(autoincrement())
  fecha           DateTime
  estado          Estado
  usuarioId       Int
  coleccionAvalId Int
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  usuario         Usuario        @relation(fields: [usuarioId], references: [id])
  coleccionAval   ColeccionAval  @relation(fields: [coleccionAvalId], references: [id])

  @@index([usuarioId])
  @@index([estado])
  @@index([createdAt])
}

// =====================================================================
//  NUEVO MODELO: AvalTecnico  (reemplaza a Solicitud)
// =====================================================================
model AvalTecnico {
  id                 Int                    @id @default(autoincrement())
  coleccionAvalId    Int                    @unique
  descripcion        String                 @db.VarChar(600)
  archivo            String?                 @db.VarChar(355)
  // Datos específicos del aval técnico
 
  fechaHoraSalida        DateTime
  fechaHoraRetorno       DateTime
  transporteSalida   String                 @db.VarChar(255)
  transporteRetorno  String                 @db.VarChar(255)
  oficiales          Int
  atletas            Int
  observaciones      String?                @db.VarChar(600)
  deleted            Boolean                @default(false)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt

  coleccionAval      ColeccionAval          @relation(fields: [coleccionAvalId], references: [id])

  objetivos          AvalObjetivo[]
  criterios          AvalCriterio[]
  requerimientos     AvalRequerimiento[]
  historial          HistorialAvalTecnico[]
  deportistasAval    DeportistaAval[]

  @@index([coleccionAvalId])
  @@index([fechaHoraSalida])
  @@index([fechaHoraRetorno])
  @@index([createdAt])
  @@index([deleted])
}

// ------------------
// OBJETIVOS DEL AVAL
// ------------------
model AvalObjetivo {
  id            Int         @id @default(autoincrement())
  avalTecnicoId Int
  orden         Int
  descripcion   String      @db.VarChar(600)

  avalTecnico AvalTecnico @relation(fields: [avalTecnicoId], references: [id], onDelete: Cascade)

  @@index([avalTecnicoId])
  @@unique([avalTecnicoId, orden])
}

// ------------------
// CRITERIOS DE SELECCIÓN DEL AVAL
// ------------------
model AvalCriterio {
  id            Int         @id @default(autoincrement())
  avalTecnicoId Int
  orden         Int
  descripcion   String      @db.VarChar(600)

  avalTecnico   AvalTecnico @relation(fields: [avalTecnicoId], references: [id])

  @@index([avalTecnicoId])
  @@unique([avalTecnicoId, orden])
}

// ------------------
// REQUERIMIENTOS DEL AVAL (antes Requerimiento)
// ------------------
model AvalRequerimiento {
  id             Int            @id @default(autoincrement())
  avalTecnicoId  Int
  rubro          String         @db.VarChar(255)
  cantidadDias   String         @db.VarChar(255)
  valorUnitario  Decimal?       @db.Decimal(12, 2)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  avalTecnico    AvalTecnico    @relation(fields: [avalTecnicoId], references: [id])

  @@index([avalTecnicoId])
}

// ------------------
// HISTORIAL DEL AVAL TÉCNICO (antes HistorialSolicitud)
// ------------------
model HistorialAvalTecnico {
  id             Int          @id @default(autoincrement())
  estado         Estado
  usuarioId      Int
  avalTecnicoId  Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  usuario        Usuario      @relation(fields: [usuarioId], references: [id])
  avalTecnico    AvalTecnico  @relation(fields: [avalTecnicoId], references: [id])

  @@index([usuarioId])
  @@index([estado])
  @@index([createdAt])
  @@index([avalTecnicoId])
}

// ------------------
// DEPORTISTAS LIGADOS A UN AVAL TÉCNICO
// ------------------
model DeportistaAval {
  id             Int          @id @default(autoincrement())
  avalTecnicoId  Int
  deportistaId   Int
  rol            String       @db.VarChar(100) // deportista, entrenador, delegado, etc.

  avalTecnico    AvalTecnico  @relation(fields: [avalTecnicoId], references: [id])
  deportista     Deportista   @relation(fields: [deportistaId], references: [id])

  @@unique([avalTecnicoId, deportistaId])
  @@index([avalTecnicoId])
  @@index([deportistaId])
}


// ------------------
// ENTRENADORES LIGADOS A UN AVAL 
// ------------------

model ColeccionEntrenador {
  id              Int         @id @default(autoincrement())
  coleccionAvalId Int
  usuarioId       Int
  rol             String      @db.VarChar(100) // entrenador principal, asistente, etc.
  esPrincipal     Boolean

  usuario         Usuario     @relation(fields: [usuarioId], references: [id])
  coleccionAval   ColeccionAval @relation(fields: [coleccionAvalId], references: [id])

  @@unique([coleccionAvalId, usuarioId]) // no repetir entrenador en el mismo aval
  @@index([usuarioId])
}

// =====================================================================
//  MODELOS EXISTENTES SIN CAMBIOS MAYORES (sección original)
//  Solo se actualizan las FK que antes apuntaban a Solicitud/Requerimiento
// =====================================================================

model Actividad {
  id          Int      @id @default(autoincrement())
  nombre      String   @db.VarChar(255)
  numero      Int
  descripcion String   @db.VarChar(600)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items       Item[]

  @@index([numero])
}

model Item {
  id              Int             @id @default(autoincrement())
  actividadId     Int
  nombre          String          @db.VarChar(255)
  numero          Int
  descripcion     String          @db.VarChar(600)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  actividad       Actividad       @relation(fields: [actividadId], references: [id])
  pdaItems        PdaItem[]
  financieroItems FinancieroItem[]

  @@index([actividadId])
  @@index([numero])
}

// ------------------
//  PDA y su historial (sin cambios salvo FK)
// ------------------
model Pda {
  id                  Int             @id @default(autoincrement())
  coleccionAvalId     Int
  descripcion         String          @db.VarChar(600)
  documento           String          @db.VarChar(355)
  responsableAnticipo Int
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  deleted             Boolean         @default(false)

  coleccionAval       ColeccionAval   @relation(fields: [coleccionAvalId], references: [id])
  historialPda        HistorialPda[]
  pdaItems            PdaItem[]

  @@index([createdAt])
  @@index([deleted])
}

model HistorialPda {
  id         Int      @id @default(autoincrement())
  estado     Estado
  usuarioId  Int
  pdaId      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  usuario    Usuario  @relation(fields: [usuarioId], references: [id])
  pda        Pda      @relation(fields: [pdaId], references: [id])

  @@index([usuarioId])
  @@index([estado])
  @@index([createdAt])
  @@index([pdaId])
}

model PdaItem {
  id         Int      @id @default(autoincrement())
  pdaId      Int
  itemId     Int
  presupuesto Decimal @db.Decimal(12, 2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  pda        Pda      @relation(fields: [pdaId], references: [id])
  item       Item     @relation(fields: [itemId], references: [id])

  @@index([pdaId])
  @@index([itemId])
}

// ------------------
//  DTM y su historial
// ------------------
model Dtm {
  id                  Int             @id @default(autoincrement())
  coleccionAvalId     Int
  descripcion         String          @db.VarChar(600)
  documento           String          @db.VarChar(355)
  observacion         String?         @db.VarChar(600)
  fechaPresentacion   DateTime
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  deleted             Boolean         @default(false)

  coleccionAval       ColeccionAval   @relation(fields: [coleccionAvalId], references: [id])
  historialDtm        HistorialDtm[]

  @@index([createdAt])
  @@index([fechaPresentacion])
  @@index([descripcion])
  @@index([deleted])
}

model HistorialDtm {
  id         Int      @id @default(autoincrement())
  estado     Estado
  usuarioId  Int
  dtmId      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  usuario    Usuario  @relation(fields: [usuarioId], references: [id])
  dtm        Dtm      @relation(fields: [dtmId], references: [id])

  @@index([usuarioId])
  @@index([estado])
  @@index([createdAt])
  @@index([dtmId])
}

// ------------------
//  FINANCIERO y su historial / ítems
// ------------------
model Financiero {
  id                Int               @id @default(autoincrement())
  coleccionAvalId   Int
  descripcion       String            @db.VarChar(600)
  cuentaBancaria    String            @db.VarChar(255)
  fondos            String            @db.VarChar(255)
  notas             String?           @db.VarChar(400)
  razonSocial       String            @db.VarChar(255)
  ruc               String            @db.VarChar(50)
  direccion         String            @db.VarChar(255)
  telefono          String            @db.VarChar(50)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deleted           Boolean           @default(false)

  coleccionAval     ColeccionAval     @relation(fields: [coleccionAvalId], references: [id])
  historialFinanciero HistorialFinanciero[]
  financieroItems   FinancieroItem[]

  @@index([createdAt])
  @@index([descripcion])
  @@index([deleted])
}

model HistorialFinanciero {
  id             Int       @id @default(autoincrement())
  estado         Estado
  usuarioId      Int
  financieroId   Int
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  usuario        Usuario   @relation(fields: [usuarioId], references: [id])
  financiero     Financiero @relation(fields: [financieroId], references: [id])

  @@index([usuarioId])
  @@index([estado])
  @@index([createdAt])
  @@index([financieroId])
}

model FinancieroItem {
  id             Int        @id @default(autoincrement())
  financieroId   Int
  itemId         Int
  precioAsignado Decimal @db.Decimal(12, 2)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  financiero     Financiero  @relation(fields: [financieroId], references: [id])
  item           Item        @relation(fields: [itemId], references: [id])

  @@index([financieroId])
  @@index([itemId])
}


